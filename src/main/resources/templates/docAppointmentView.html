<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title th:text="#{calendar.title}">Doctor's Appointments</title>
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
  <link rel="stylesheet" th:href="@{/css/animate.css}">
  <link rel="stylesheet" th:href="@{/css/owl.carousel.css}">
  <link rel="stylesheet" th:href="@{/css/owl.theme.default.min.css}">
  <link rel="stylesheet" th:href="@{/css/tooplate-style.css}">
  
  <style>
    /* Desactiva TODO enlace dentro del calendario */
    #calendar a {
      color: inherit !important;
      text-decoration: none !important;
      pointer-events: none !important;
      cursor: default !important;
    }
    /* Reactiva los enlaces de los eventos */
    #calendar .fc-daygrid-event, 
    #calendar .fc-daygrid-event a {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    #calendar .fc-daygrid-event {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    /* Style for past days in calendar */
    .fc-day-past {
      background-color: #f8f9fa !important;
    }
    /* Style for past events */
    .past-event {
      background-color: #e9ecef !important;
      border-color: #dee2e6 !important;
      color: #6c757d !important;
      opacity: 0.9;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #calendar {
      max-width: 900px;
      margin: 20px auto;
    }
    #no-appointments {
      text-align: center;
      color: #666;
      margin-top: 50px;
    }
    .language-switcher select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    /* Conflict Alert Modal */
    #conflictAlert .modal-content {
      border-left: 5px solid #dc3545;
    }
    #conflictAlert .modal-header {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body th:data-doctor-id="${doctorId}">
  <!-- PRE LOADER -->
  <section class="preloader">
    <div class="spinner">
      <span class="spinner-rotate"></span>
    </div>
  </section>
  <header>
    <div class="container">
      <div class="row">
        <div class="col-md-4 col-sm-5">
          <p>[[#{app.title}]]</p>
        </div>
        <div class="col-md-8 col-sm-7 text-align-right">
          <span class="phone-icon"><i class="fa fa-phone"></i>[[#{contact.phone}]]</span>
          <span class="date-icon"><i class="fa fa-calendar-plus-o"></i>[[#{opening.hours}]]</span>
          <span class="email-icon"><i class="fa fa-envelope-o"></i> <a href="#">[[#{contact.email}]]</a></span>
        </div>
      </div>
    </div>
  </header>
  <!-- MENU -->
  <section class="navbar navbar-default navbar-static-top" role="navigation">
    <div class="container">
      <div class="row w-100 align-items-center">
        <div class="col-md-6">
          <a href="/" class="navbar-brand"><i class="fa fa-h-square"></i>ealth Center</a>
        </div>
        <div class="col-md-6 text-end">
          <div class="language-switcher">
            <a href="?lang=en">
              <img src="/images/flag-en.png" alt="" style="width:24px;height:16px; display:inline-block;">
            </a>
            <a href="?lang=es">
              <img src="/images/flag-es.png" alt="" style="width:24px;height:16px; display:inline-block;">
            </a>
            <a href="?lang=fr">
              <img src="/images/flag-fr.png" alt="" style="width:24px;height:16px; display:inline-block;">
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- Botón Nueva Cita -->
  <div class="container mt-3">
    <button id="newAppointmentBtn" class="btn btn-success" th:text="#{calendar.button.newAppointment}">New Appointment</button>
  </div>
  <div id="no-appointments" style="display:none;">
    [[#{calendar.noAppointments}]]
  </div>
  <div id="calendar"></div>
  <!-- Bootstrap Modal -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="appointmentModalLabel">
            [[#{calendar.modal.title}]]
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="appointmentForm">
            <div class="mb-3">
              <label for="input-patient" class="form-label">DNI</label>
              <input
                type="text"
                class="form-control"
                id="input-patient"
                name="patientDni"
                required
              />
            </div>
            <div class="mb-3">
              <label for="input-date" class="form-label">[[#{calendar.form.date}]]</label>
              <input type="date" class="form-control" id="input-date" name="date" required>
            </div>
            <div class="mb-3">
              <label for="input-start" class="form-label">[[#{calendar.form.startTime}]]</label>
              <input type="time" class="form-control" id="input-start" name="startTime" required>
            </div>
            <div class="mb-3">
              <label for="input-end" class="form-label">[[#{calendar.form.endTime}]]</label>
              <input type="time" class="form-control" id="input-end" name="endTime" required>
            </div>
            <div class="mb-3">
              <label for="input-purpose" class="form-label">[[#{calendar.form.purpose}]]</label>
              <textarea class="form-control" id="input-purpose" name="appointmentPurpose"></textarea>
            </div>
            <div class="mb-3">
              <label for="input-observations" class="form-label">[[#{calendar.form.observations}]]</label>
              <textarea class="form-control" id="input-observations" name="observations"></textarea>
            </div>
            <div id="form-error" class="alert alert-danger d-none"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="saveBtn">[[#{calendar.button.save}]]</button>
          <button id="deleteButton" type="button" class="btn btn-danger">[[#{calendar.button.delete}]]</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[[#{calendar.button.close}]]</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Conflict Alert Modal -->
  <div class="modal fade" id="conflictAlert" tabindex="-1" aria-labelledby="conflictAlertLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="conflictAlertLabel">
            <i class="fa fa-exclamation-triangle me-2"></i>
            <span th:text="#{calendar.conflict.title}">Time Conflict Detected</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="conflictMessage" th:text="#{calendar.conflict.message}">
            You already have an appointment at that time. Please select another time slot.
          </p>
          <p id="conflictDetails" class="fw-bold"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{calendar.button.close}">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Past Date Alert Modal -->
  <div class="modal fade" id="pastDateAlert" tabindex="-1" aria-labelledby="pastDateAlertLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="pastDateAlertLabel">
            <i class="fa fa-clock-o me-2"></i>
            <span th:text="#{calendar.pastDate.title}">Past Date Warning</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="pastDateMessage" th:text="#{calendar.pastDate.message}">
            Appointments in the past cannot be modified or rescheduled.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{calendar.button.close}">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tooltip.js@1"></script>
  <!-- Bootstrap 5 JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
      var rawJson = /*[[${appointmentsJson}]]*/ [];
      var rawAppointments = JSON.parse(rawJson);
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      
      var appointmentEvents = rawAppointments.map(function(apt) {
          var eventDate = new Date(apt.date);
          eventDate.setHours(0, 0, 0, 0);
          var isPastEvent = eventDate < today;
          
          return {
            id:           apt.appointmentId,
            title:        apt.appointmentPurpose,
            start:        apt.date + 'T' + apt.startTime,
            end:          apt.date + 'T' + apt.endTime,
            purpose:      apt.appointmentPurpose,
            observations: apt.observations,
            patientDni:   apt.patient.dni,
            patientName:  apt.patient.name + ' ' + apt.patient.surname,
            doctorName:   apt.doctor.name  + ' ' + apt.doctor.surname,
            isPast:       isPastEvent,
            className:    isPastEvent ? 'past-event' : ''
          };
      });
      var currentLocale = /*[[${#locale.language}]]*/ 'en';
    /*]]>*/
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        locale: currentLocale,
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        navLinks: false,
        nowIndicator: true,
        events: window.appointmentEvents,
        eventTimeFormat: {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        },
        dayCellDidMount: function(info) {
          var a = info.el.querySelector('.fc-daygrid-day-number a');
          if (a) a.replaceWith(document.createTextNode(a.textContent));
        },
        dayHeaderDidMount: function(info) {
          var a = info.el.querySelector('.fc-col-header-cell-cushion a');
          if (a) a.replaceWith(document.createTextNode(a.textContent));
        },
        eventDrop: function(info) {
          // Check if event is in the past
          if (isPastEvent(info.event)) {
            info.revert(); // Revert the event to its original position
            showPastDateAlert();
            return;
          }
          
          // Handle drag-and-drop time conflict
          if (hasTimeConflict(info.event, info.event.id)) {
            info.revert(); // Revert the event to its original position
            showConflictAlert();
            return;
          }
          
          // If no conflict, update the appointment
          updateAppointmentAfterDrop(info.event);
        },
        eventResize: function(info) {
          // Check if event is in the past
          if (isPastEvent(info.event)) {
            info.revert(); // Revert the event to its original position
            showPastDateAlert();
            return;
          }
          
          // Handle resize time conflict
          if (hasTimeConflict(info.event, info.event.id)) {
            info.revert(); // Revert the event to its original position
            showConflictAlert();
            return;
          }
          
          // If no conflict, update the appointment
          updateAppointmentAfterDrop(info.event);
        },
        eventClick: function(info) {
          var event = info.event;
          var apptId = event.id;
          var bodyEl = document.body;
          var isPatient = !!bodyEl.dataset.patientDni;
          var isPastEvent = event.extendedProps.isPast;
          var baseUrl = isPatient
            ? '/api/patients/appointments/' + apptId
            : '/api/doctors/appointments/'  + apptId;
          
          document.getElementById('input-date').value = event.startStr.split('T')[0];
          document.getElementById('input-start').value = event.startStr.split('T')[1].substr(0,5);
          document.getElementById('input-end').value = event.endStr.split('T')[1].substr(0,5);
          document.getElementById('input-purpose').value = event.extendedProps.purpose || '';
          document.getElementById('input-observations').value = event.extendedProps.observations || '';
          document.getElementById('input-patient').value = event.extendedProps.patientDni || '';
          document.getElementById('form-error').classList.add('d-none');
          
          // Disable all form fields for past events
          var formFields = ['input-date', 'input-start', 'input-end', 'input-purpose', 'input-observations', 'input-patient'];
          
          formFields.forEach(function(id) {
            var inputEl = document.getElementById(id);
            // Disable for past events or if patient view
            inputEl.disabled = isPastEvent || (isPatient && (id === 'input-purpose' || id === 'input-observations'));
          });
          
          var modalEl = document.getElementById('appointmentModal');
          var bsModal = new bootstrap.Modal(modalEl);
          bsModal.show();
          
          // Hide save and delete buttons for past events
          document.getElementById('saveBtn').style.display = isPastEvent ? 'none' : 'inline-block';
          document.getElementById('deleteButton').style.display = isPastEvent ? 'none' : 'inline-block';
          
          // Update modal title - "View Appointment" for past events
          document.getElementById('appointmentModalLabel').textContent = isPastEvent ? 
            /*[[#{calendar.modal.viewTitle}]]*/ 'View Appointment' : 
            /*[[#{calendar.modal.editTitle}]]*/ 'Edit Appointment';
            
          // Save button handler - only for future events
          if (!isPastEvent) {
            document.getElementById('saveBtn').onclick = function() {
              let startVal = document.getElementById('input-start').value;
              let endVal = document.getElementById('input-end').value;
              var dateVal = document.getElementById('input-date').value;
              
              // Check if the appointment is in the past
              const selectedDateTime = new Date(dateVal + 'T' + startVal);
              const now = new Date();
              
              if (selectedDateTime < now) {
                showPastDateAlert();
                return;
              }
              
              // Check for time conflicts before saving
              if (checkTimeConflict(dateVal, startVal, endVal, apptId)) {
                showConflictAlert();
                return;
              }
              
              var payload = {
                date: dateVal,
                startTime: startVal.length === 5 ? startVal + ':00' : startVal,
                endTime: endVal.length === 5 ? endVal + ':00' : endVal
              };
              
              if (!isPatient) {
                payload.appointmentPurpose = document.getElementById('input-purpose').value;
                payload.observations = document.getElementById('input-observations').value;
              }
              
              fetch(baseUrl, {
                method: 'PUT',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify(payload)
              })
              .then(function(res){
                if (!res.ok) return res.json().then(function(err){ throw err; });
                return res.json();
              })
              .then(function(updated){
                event.setStart(updated.date + 'T' + updated.startTime);
                event.setEnd(updated.date + 'T' + updated.endTime);
                if (!isPatient) {
                  event.setProp('title', updated.appointmentPurpose);
                  event.setExtendedProp('purpose', updated.appointmentPurpose);
                  event.setExtendedProp('observations', updated.observations);
                }
                bsModal.hide();
              })
              .catch(function(err){
                var errDiv = document.getElementById('form-error');
                errDiv.textContent = err.message || /*[[#{calendar.error.general}]]*/ 'Validation error';
                errDiv.classList.remove('d-none');
              });
            };
            
            document.getElementById('deleteButton').onclick = function () {
              if (!confirm(/*[[#{calendar.confirm.delete}]]*/ '¿Estás seguro de que quieres eliminar esta cita?')) return;
              
              fetch(baseUrl, { method: 'DELETE' })
              .then(response => {
                if (response.ok) {
                  info.event.remove();
                  bsModal.hide();
                } else {
                  alert(/*[[#{calendar.error.delete}]]*/ 'Error al eliminar la cita.');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert(/*[[#{calendar.error.general}]]*/ 'Ocurrió un error al intentar eliminar la cita.');
              });
            };
          }
        },
        editable: true // Enable drag and drop
      });
      
      calendar.render();
      
      // New function to update appointment after drag & drop
      function updateAppointmentAfterDrop(event) {
        const apptId = event.id;
        const dateStr = event.startStr.split('T')[0];
        const startTimeStr = event.startStr.split('T')[1].substr(0,8);
        const endTimeStr = event.endStr.split('T')[1].substr(0,8);
        
        const bodyEl = document.body;
        const isPatient = !!bodyEl.dataset.patientDni;
        const baseUrl = isPatient
          ? '/api/patients/appointments/' + apptId
          : '/api/doctors/appointments/'  + apptId;
        
        const payload = {
          date: dateStr,
          startTime: startTimeStr,
          endTime: endTimeStr
        };
        
        // Add purpose and observations if doctor view
        if (!isPatient) {
          payload.appointmentPurpose = event.extendedProps.purpose || '';
          payload.observations = event.extendedProps.observations || '';
        }
        
        fetch(baseUrl, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        })
        .then(function(res){
          if (!res.ok) {
            event.revert(); // Revert if server says no
            return res.json().then(function(err){ throw err; });
          }
          return res.json();
        })
        .catch(function(err){
          console.error('Error updating appointment:', err);
          alert(/*[[#{calendar.error.general}]]*/ 'Error al actualizar la cita.');
        });
      }
      
      // Function to check for time conflicts
      function checkTimeConflict(date, startTime, endTime, currentAppointmentId) {
        // Format times to match event format
        if (startTime.length === 5) startTime += ':00';
        if (endTime.length === 5) endTime += ':00';
        
        const start = new Date(date + 'T' + startTime);
        const end = new Date(date + 'T' + endTime);
        
        // Check against all events
        for (const event of window.appointmentEvents) {
          // Skip comparing with the same appointment
          if (event.id === currentAppointmentId) continue;
          
          // Only check events on the same day
          if (event.start.split('T')[0] !== date) continue;
          
          const eventStart = new Date(event.start);
          const eventEnd = new Date(event.end);
          
          // Check if there's an overlap
          if ((start < eventEnd && end > eventStart)) {
            // Store conflicting appointment details for message
            window.conflictingAppointment = {
              time: eventStart.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + 
                    ' - ' + 
                    eventEnd.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
              purpose: event.purpose || 'Appointment'
            };
            return true;
          }
        }
        return false;
      }
      
      // Function to check conflicts for drag & drop events
      function hasTimeConflict(event, currentId) {
        const dateStr = event.startStr.split('T')[0];
        const startTime = event.startStr.split('T')[1];
        const endTime = event.endStr.split('T')[1];
        
        return checkTimeConflict(dateStr, startTime, endTime, currentId);
      }
      
      // Function to show conflict alert
      function showConflictAlert() {
        const conflictDetails = window.conflictingAppointment 
          ? `Conflicting appointment: ${window.conflictingAppointment.time} - ${window.conflictingAppointment.purpose}`
          : '';
          
        document.getElementById('conflictDetails').textContent = conflictDetails;
        const conflictModal = new bootstrap.Modal(document.getElementById('conflictAlert'));
        conflictModal.show();
      }
      
      // Function to show past date alert
      function showPastDateAlert() {
        const pastDateModal = new bootstrap.Modal(document.getElementById('pastDateAlert'));
        pastDateModal.show();
      }
      
      // Function to check if event is in the past
      function isPastEvent(event) {
        const eventDate = new Date(event.startStr);
        const now = new Date();
        return eventDate < now;
      }
      
      // Nuevo Appointment Handler
      document.getElementById('newAppointmentBtn').addEventListener('click', function() {
        document.getElementById('input-date').value = '';
        document.getElementById('input-start').value = '';
        document.getElementById('input-end').value = '';
        document.getElementById('input-purpose').value = '';
        document.getElementById('input-observations').value = '';
        document.getElementById('input-patient').value = '';
        document.getElementById('form-error').classList.add('d-none');
        
        // Enable all fields for new appointments
        ['input-date', 'input-start', 'input-end', 'input-purpose', 'input-observations', 'input-patient'].forEach(function(id) {
          document.getElementById(id).disabled = false;
        });
        
        document.getElementById('saveBtn').style.display = 'inline-block';
        document.getElementById('deleteButton').style.display = 'none';
        document.getElementById('appointmentModalLabel').textContent = /*[[#{calendar.modal.newTitle}]]*/ 'New Appointment';
        
        const doctorId = document.body.dataset.doctorId;
        const baseUrl = `/api/doctors/${doctorId}/appointments`;
        const bsModal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        
        document.getElementById('saveBtn').onclick = function() {
          const startVal = document.getElementById('input-start').value;
          const endVal = document.getElementById('input-end').value;
          const dateVal = document.getElementById('input-date').value;
          
          // Validate the date is not in the past
          const selectedDate = new Date(dateVal);
          const selectedDateTime = new Date(dateVal + 'T' + startVal);
          const now = new Date();
          
          if (selectedDateTime < now) {
            showPastDateAlert();
            return;
          }
          
          // Check for time conflicts before saving
          if (checkTimeConflict(dateVal, startVal, endVal, null)) {
            showConflictAlert();
            return;
          }
          
          const payload = {
            date: dateVal,
            startTime: startVal.length === 5 ? startVal + ':00' : startVal,
            endTime: endVal.length === 5 ? endVal + ':00' : endVal,
            appointmentPurpose: document.getElementById('input-purpose').value,
            observations: document.getElementById('input-observations').value,
            patient: {
              dni: document.getElementById('input-patient').value 
            }
          };
          
          fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => { throw new Error(err.message || /*[[#{calendar.error.general}]]*/ 'Error creating appointment'); });
            }
            return response.json();
          })
          .then(data => {
            calendar.refetchEvents();
            bsModal.hide();
          })
          .catch(error => {
            document.getElementById('form-error').textContent = error.message;
            document.getElementById('form-error').classList.remove('d-none');
          });
        };
        
        bsModal.show();
      });
    });
  </script>
  <!-- SCRIPTS -->
  <script th:src="@{/js/jquery.js}"></script>
  <script th:src="@{/js/bootstrap.min.js}"></script>
  <script th:src="@{/js/jquery.sticky.js}"></script>
  <script th:src="@{/js/jquery.stellar.min.js}"></script>
  <script th:src="@{/js/wow.min.js}"></script>
  <script th:src="@{/js/smoothscroll.js}"></script>
  <script th:src="@{/js/owl.carousel.min.js}"></script>
  <script th:src="@{/js/custom.js}"></script>
</body>
</html>