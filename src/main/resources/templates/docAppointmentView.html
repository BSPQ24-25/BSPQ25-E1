<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8" >
  <title>Doctor's Appointments</title>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

  <!-- Bootstrap 5 CSS (for the modal) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />


  <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
  <link rel="stylesheet" th:href="@{/css/animate.css}">
  <link rel="stylesheet" th:href="@{/css/owl.carousel.css}">
  <link rel="stylesheet" th:href="@{/css/owl.theme.default.min.css}">

  <link rel="stylesheet" th:href="@{/css/tooplate-style.css}">
  
  <style>
    /* Desactiva TODO enlace dentro del calendario */
    #calendar a {
      color: inherit !important;
      text-decoration: none !important;
      pointer-events: none !important;
      cursor: default !important;
    }

    /* Reactiva los enlaces de los eventos (pueden variar seg√∫n tu versi√≥n de FullCalendar) */
    #calendar .fc-daygrid-event,
    #calendar .fc-daygrid-event a {
      pointer-events: auto !important;
      cursor: pointer !important;
    }

    /* Si tus eventos usan <div> en vez de <a>, aplica tambi√©n a esos */
    #calendar .fc-daygrid-event {
      pointer-events: auto !important;
      cursor: pointer !important;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #calendar {
      max-width: 900px;
      margin: 20px auto;
    }

    #no-appointments {
      text-align: center;
      color: #666;
      margin-top: 50px;
    }

    .language-switcher select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
}
    
  </style>

</head>

<body th:data-doctor-id="${doctorId}">

  <!-- PRE LOADER -->
  <section class="preloader">
    <div class="spinner">

      <span class="spinner-rotate"></span>

    </div>
  </section>

  <header>
    <div class="container">
      <div class="row">

        <div class="col-md-4 col-sm-5">
          <p>[[#{app.title}]]</p>
        </div>

        <div class="col-md-8 col-sm-7 text-align-right">
          <span class="phone-icon"><i class="fa fa-phone"></i>[[#{contact.phone}]]</span>
          <span class="date-icon"><i class="fa fa-calendar-plus-o"></i>[[#{opening.hours}]]</span>
          <span class="email-icon"><i class="fa fa-envelope-o"></i> <a href="#">[[#{contact.email}]]</a></span>
        </div>

      </div>
    </div>
  </header>

  <!-- MENU -->
  <section class="navbar navbar-default navbar-static-top" role="navigation">
    <div class="container">
      <a href="/" class="navbar-brand"><i class="fa fa-h-square"></i>ealth Center</a>
    </div>
    </div>
    <div class="language-switcher">
      <select onchange="window.location.href = '?lang=' + this.value">
        <option value="" selected disabled hidden>üåê [[#{language.select}]]</option>
        
            <option value="en">&#x1F1FA;&#x1F1F8; English</option>
            <option value="es">&#x1F1EA;&#x1F1F8; Espa√±ol</option>
            <option value="fr">&#x1F1EB;&#x1F1F7; Fran√ßais</option>
          
      </select>
    </div>

  </section>

  <!-- Contenedor que muestra si no hay citas -->
  <div id="no-appointments" style="display:none;">
    [[#{calendar.noAppointments}]]
  </div>

  <div id="calendar"></div>

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="appointmentModalLabel">
            [[#{calendar.modal.title}]]
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="appointmentForm">
            <div class="mb-3">
              <label for="input-date" class="form-label">[[#{calendar.form.date}]]</label>
              <input type="date" class="form-control" id="input-date" name="date" required>
            </div>
            <div class="mb-3">
              <label for="input-start" class="form-label">[[#{calendar.form.startTime}]]</label>
              <input type="time" class="form-control" id="input-start" name="startTime" required>
            </div>
            <div class="mb-3">
              <label for="input-end" class="form-label">[[#{calendar.form.endTime}]]</label>
              <input type="time" class="form-control" id="input-end" name="endTime" required>
            </div>
            <div class="mb-3">
              <label for="input-purpose" class="form-label">[[#{calendar.form.purpose}]]</label>
              <textarea class="form-control" id="input-purpose" name="appointmentPurpose"></textarea>
            </div>
            <div class="mb-3">
              <label for="input-observations" class="form-label">[[#{calendar.form.observations}]]</label>
              <textarea class="form-control" id="input-observations" name="observations"></textarea>
            </div>
            <div id="form-error" class="alert alert-danger d-none"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="saveBtn">[[#{calendar.button.save}]]</button>
          <button id="deleteButton" type="button" class="btn btn-danger">[[#{calendar.button.delete}]]</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[[#{calendar.button.close}]]</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tooltip.js@1"></script>
  <!-- Bootstrap 5 JS bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script th:inline="javascript">
    /*<![CDATA[*/
    // Aqu√≠ Thymeleaf reemplaza EL ARRAY JSON sin comillas extras:
    var rawJson = /*[[${appointmentsJson}]]*/[];

    var rawAppointments = JSON.parse(rawJson);
    var appointmentEvents = rawAppointments.map(function (apt) {
      return {
        id: apt.appointmentId,
        title: apt.appointmentPurpose,
        start: apt.date + 'T' + apt.startTime,
        end: apt.date + 'T' + apt.endTime,
        purpose: apt.appointmentPurpose,
        observations: apt.observations,
        patientName: apt.patient.name + ' ' + apt.patient.surname,
        doctorName: apt.doctor.name + ' ' + apt.doctor.surname
      };
    });

    /*]]>*/
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Only events are clickable; disable navLinks
      var calendar = new FullCalendar.Calendar(
        document.getElementById('calendar'),
        {
          locale: 'en',
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          navLinks: false,  // disable day/week name clicks
          nowIndicator: true,
          events: window.appointmentEvents,
          eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          },

          // Quitar el <a> de los n√∫meros de d√≠a
          dayCellDidMount: function (info) {
            var a = info.el.querySelector('.fc-daygrid-day-number a');
            if (a) a.replaceWith(document.createTextNode(a.textContent));
          },
          // Quitar el <a> de los encabezados (Mon, Tue, ...)
          dayHeaderDidMount: function (info) {
            var a = info.el.querySelector('.fc-col-header-cell-cushion a');
            if (a) a.replaceWith(document.createTextNode(a.textContent));
          },

          // Only this click opens the modal

          eventClick: function (info) {
            var event = info.event;
            var apptId = event.id;
            var bodyEl = document.body;
            var isPatient = !!bodyEl.dataset.patientDni;
            var baseUrl = isPatient
              ? '/api/patients/appointments/' + apptId
              : '/api/doctors/appointments/' + apptId;

            // 1) Prefill form
            document.getElementById('input-date').value = event.startStr.split('T')[0];
            document.getElementById('input-start').value = event.startStr.split('T')[1].substr(0, 5);
            document.getElementById('input-end').value = event.endStr.split('T')[1].substr(0, 5);
            document.getElementById('input-purpose').value = event.extendedProps.purpose || '';
            document.getElementById('input-observations').value = event.extendedProps.observations || '';
            document.getElementById('form-error').classList.add('d-none');

            // 2) Enable/disable fields
            ['input-purpose', 'input-observations'].forEach(function (id) {
              document.getElementById(id).disabled = isPatient;
            });

            // 3) Show modal
            var modalEl = document.getElementById('appointmentModal');
            var bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();

            // 4) Save handler
            document.getElementById('saveBtn').onclick = function () {
              let startVal = document.getElementById('input-start').value;
              let endVal = document.getElementById('input-end').value;

              var payload = {};
              // always include date/time
              payload.date = document.getElementById('input-date').value;
              payload.startTime = startVal.length === 5 ? startVal + ':00' : startVal;
              payload.endTime = endVal.length === 5 ? endVal + ':00' : endVal;
              // only if doctor, include purpose/obs
              if (!isPatient) {
                payload.appointmentPurpose = document.getElementById('input-purpose').value;
                payload.observations = document.getElementById('input-observations').value;
              }
              fetch(baseUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              })
                .then(function (res) {
                  if (!res.ok) {
                    return res.json().then(function (err) {
                      throw err;
                    });
                  }
                  return res.json();
                })
                .then(function (updated) {
                  // Actualizar evento en pantalla
                  event.setStart(updated.date + 'T' + updated.startTime);
                  event.setEnd(updated.date + 'T' + updated.endTime);
                  if (!isPatient) {
                    event.setProp('title', updated.appointmentPurpose);
                    event.setExtendedProp('purpose', updated.appointmentPurpose);
                    event.setExtendedProp('observations', updated.observations);
                  }
                  bsModal.hide();
                })
                .catch(function (err) {
                  // Mostrar mensaje de validaci√≥n
                  var errDiv = document.getElementById('form-error');
                  var msg = err.message || 'Validation error';
                  errDiv.textContent = msg;
                  errDiv.classList.remove('d-none');
                });

              document.getElementById('deleteButton').onclick = function () {
                if (!confirm('¬øEst√°s seguro de que quieres eliminar esta cita?')) {
                  return;
                }

                fetch(`/api/patients/appointments/${info.event.id}`, {
                  method: 'DELETE'
                })
                  .then(response => {
                    if (response.ok) {
                      info.event.remove(); // Elimina la cita del calendario
                      var appointmentModalEl = document.getElementById('appointmentModal');
                      var modal = bootstrap.Modal.getInstance(appointmentModalEl);
                      modal.hide();
                    } else {
                      alert('Error al eliminar la cita.');
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Ocurri√≥ un error al intentar eliminar la cita.');
                  });
              };
            };

          }
        }
      );

      calendar.render();
    });
  </script>


  <!-- SCRIPTS -->
  <script th:src="@{/js/jquery.js}"></script>
  <script th:src="@{/js/bootstrap.min.js}"></script>
  <script th:src="@{/js/jquery.sticky.js}"></script>
  <script th:src="@{/js/jquery.stellar.min.js}"></script>
  <script th:src="@{/js/wow.min.js}"></script>
  <script th:src="@{/js/smoothscroll.js}"></script>
  <script th:src="@{/js/owl.carousel.min.js}"></script>
  <script th:src="@{/js/custom.js}"></script>

</body>

</html>