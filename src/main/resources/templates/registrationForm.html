
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>User Registration</title>
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <form id="registrationForm">
    <h1>User Registration</h1>
    <div class="input-group">
      <label for="dni">DNI:</label>
      <input type="text" id="dni" name="dni" required>
    </div>
    <div class="input-group">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required>
    </div>
    <div class="input-group">
      <label for="surname">Surname:</label>
      <input type="text" id="surname" name="surname" required>
    </div>
    <div class="input-group">
      <label for="phone">Phone:</label>
      <input type="text" id="phone" name="phone" required>
    </div>
    <div class="input-group">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
    </div>
    <div class="input-group">
      <label for="birthDate">Birth Date:</label>
      <input type="date" id="birthDate" name="birthDate" required>
    </div>
    <div class="input-group">
      <label for="gender">Gender:</label>
      <select id="gender" name="gender" required>
        <option value="" disabled selected>Select your gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="input-group">
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required>
    </div>
    <div class="input-group">
      <button type="button" id="submitButton" class="btn primary">Register</button>
    </div>
  </form>

  <script>
    document.getElementById('submitButton').addEventListener('click', function () {
        const form = document.getElementById('registrationForm');
        const formData = new FormData(form);
        
        // Convert birthDate to proper format
        const jsonData = Object.fromEntries(formData);
        jsonData.birthDate = new Date(jsonData.birthDate).toISOString().split('T')[0];
        
        fetch('/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams(formData).toString()
        })
        .then(response => {
            // We'll always parse the response text first
            return response.text().then(text => {
                if (response.ok) {
                    // Success case
                    Swal.fire({
                        icon: 'success',
                        title: 'Registration Successful',
                        text: 'You will be redirected to login page.',
                        confirmButtonColor: '#4CAF50'
                    }).then(() => {
                        window.location.href = '/login'; // Redirect to login page
                    });
                } else {
                    // Here we handle both server errors and validation errors
                    let errorMessage = text;
                    
                    // Check if the error contains our custom message about duplicate DNI/email
                    if (text.includes("DNI or email are already registered")) {
                        errorMessage = "DNI or email are already registered!";
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Registration Failed',
                        text: errorMessage,
                        confirmButtonColor: '#ff4d4d'
                    }).then(() => {
                        // Reset the form after the user closes the error alert
                        form.reset();
                        // Reset the gender dropdown to show the placeholder
                        document.getElementById('gender').selectedIndex = 0;
                    });
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Registration Failed',
                text: 'An unexpected error occurred. Please try again later.',
                confirmButtonColor: '#ff4d4d'
            }).then(() => {
                // Reset the form after the user closes the error alert
                form.reset();
                // Reset the gender dropdown to show the placeholder
                document.getElementById('gender').selectedIndex = 0;
            });
        });
    });
    </script>
</body>

</html>
